name: RDP-Kali
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    steps:

      - name: Prepare Environment
        run: |
          echo "🚀 Preparing Kali Linux SSH + Tailscale environment..."

      - name: Pull and Run Kali Linux in Docker with SSH + Tailscale
        run: |
          # Pull official Kali Linux image
          docker pull kalilinux/kali-rolling

          # Define credentials and auth key
          USERNAME="TOOLBOXLAP"
          PASSWORD="admin@123"
          AUTHKEY="${{ secrets.TAILSCALE_AUTH_KEY }}"

          # Create startup script inside container
          mkdir -p ./kali-env
          cat > ./kali-env/start.sh << 'EOF'
#!/bin/bash
set -e

USERNAME="${USERNAME:-TOOLBOXLAP}"
PASSWORD="${PASSWORD:-admin@123}"
AUTHKEY="${AUTHKEY}"

# Create user if doesn't exist
if ! id "$USERNAME" &>/dev/null; then
    useradd -m -s /bin/bash "$USERNAME"
fi

# Set password and grant sudo
echo "$USERNAME:$PASSWORD" | chpasswd
usermod -aG sudo "$USERNAME"

# Install and configure SSH
apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y openssh-server

mkdir -p /var/run/sshd
sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
echo "UsePAM no" >> /etc/ssh/sshd_config

# Start SSH
/usr/sbin/sshd

# Install Tailscale
curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list
apt-get update
apt-get install -y tailscale

# Authenticate and connect
tailscale up --authkey="$AUTHKEY" --hostname="gh-kali-\$(hostname)"

# Wait and capture IP
sleep 15
IP4=$(tailscale ip -4 2>/dev/null)

if [ -z "$IP4" ]; then
    echo "❌ Failed to obtain Tailscale IP" >&2
    tailscale status
    exit 1
fi

echo "✅ Tailscale IP: $IP4"
echo "✅ SSH User: $USERNAME"
echo "✅ Password: $PASSWORD"
echo "✅ Connect: ssh $USERNAME@$IP4"

# Keep alive
tail -f /dev/null
EOF

          chmod +x ./kali-env/start.sh

          # Run Kali container with host network for Tailscale
          docker run -d \
            --name kali-ssh \
            --network host \
            -e USERNAME="$USERNAME" \
            -e PASSWORD="$PASSWORD" \
            -e AUTHKEY="$AUTHKEY" \
            -v "$(pwd)/kali-env/start.sh:/start.sh" \
            --restart unless-stopped \
            kalilinux/kali-rolling \
            /bin/bash /start.sh

          echo "✅ Kali container started successfully."

      - name: Capture and Export Tailscale IP
        run: |
          echo "⏳ Waiting 30 seconds for Tailscale to assign IP..."
          sleep 30

          IP=$(docker exec kali-ssh tailscale ip -4 2>/dev/null)
          if [ -z "$IP" ]; then
            echo "❌ Failed to retrieve Tailscale IP" >&2
            docker logs kali-ssh
            exit 1
          fi

          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV
          echo "✅ Tailscale IP exported: $IP"

      - name: Test SSH Connectivity
        run: |
          echo "🔍 Testing SSH access to $TAILSCALE_IP on port 22..."
          nc -zv $TAILSCALE_IP 22
          if [ $? -ne 0 ]; then
            echo "❌ SSH connection failed" >&2
            exit 1
          fi
          echo "✅ SSH port 22 is reachable!"

      - name: Display Access Instructions
        run: |
          echo
          echo "=============================================="
          echo "   🎯 KALI LINUX SSH ACCESS READY (OVER TAILSCALE)"
          echo "=============================================="
          echo "   🔑 Username: TOOLBOXLAP"
          echo "   🔑 Password: admin@123"
          echo "   🌐 Address:  $TAILSCALE_IP"
          echo "   📡 Connect:  ssh TOOLBOXLAP@$TAILSCALE_IP"
          echo "   ⏱️  Session lasts up to 6 hours or until canceled."
          echo "=============================================="
          echo

      - name: Keep Alive — Maintain Persistent Session
        run: |
          while true; do
            echo "[$(date)] 💡 Workflow active — SSH session running. Cancel manually to stop."
            sleep 300
          done
