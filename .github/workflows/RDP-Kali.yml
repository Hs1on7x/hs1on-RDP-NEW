name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600
    steps:
      - name: Configure Core RDP Settings
        run: |
          # Install and configure XRDP
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xrdp xfce4 xfce4-goodies
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          echo "startxfce4" | sudo tee /etc/skel/.xsession
          sudo ufw allow 3389/tcp
          sudo ufw --force enable
          
      - name: Create RDP User with Static Password
        run: |
          password="admin@123"
          sudo useradd -m -s /bin/bash TOOLBOXLAP
          echo "TOOLBOXLAP:$password" | sudo chpasswd
          sudo usermod -aG sudo TOOLBOXLAP
          echo "startxfce4" | sudo tee /home/TOOLBOXLAP/.xsession
          sudo chmod +x /home/TOOLBOXLAP/.xsession
          sudo chown TOOLBOXLAP:TOOLBOXLAP /home/TOOLBOXLAP/.xsession
          echo "RDP_CREDS=User: TOOLBOXLAP | Password: $password" >> $GITHUB_ENV
          if ! id "TOOLBOXLAP" &>/dev/null; then
              echo "User creation failed"
              exit 1
          fi
          
      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update
          sudo apt-get install -y tailscale
          
      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-runner-$GITHUB_RUN_ID
          sleep 10
          tsIP=$(tailscale ip -4)
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 10 ]; do
              sleep 5
              tsIP=$(tailscale ip -4)
              retries=$((retries + 1))
          done
          if [ -z "$tsIP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          
      - name: Install Kali Linux Tools
        run: |
          # Install security tools
          sudo apt-get install -y nmap netcat-traditional curl wget git vim python3 python3-pip
          
          # Install tools from binaries
          cd /tmp
          wget https://github.com/OJ/gobuster/releases/download/v3.6.0/gobuster_Linux_x86_64.tar.gz
          tar -xzf gobuster_Linux_x86_64.tar.gz
          sudo mv gobuster /usr/local/bin/
          
          wget https://github.com/projectdiscovery/subfinder/releases/download/v2.6.3/subfinder_2.6.3_linux_amd64.zip
          unzip subfinder_2.6.3_linux_amd64.zip
          sudo mv subfinder /usr/local/bin/
          
          # Install Metasploit
          curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
          chmod 755 msfinstall
          sudo ./msfinstall
          
      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Wait for services to fully start
          sleep 10
          
          # Check if XRDP is listening on port 3389
          if sudo netstat -tlnp | grep :3389; then
              echo "XRDP is listening on port 3389"
          else
              echo "XRDP is NOT listening on port 3389"
              echo "Attempting to restart XRDP..."
              sudo systemctl restart xrdp-sesman
              sudo systemctl restart xrdp
              sleep 5
              sudo netstat -tlnp | grep :3389
          fi
          
          # Check service status
          echo "=== XRDP Status ==="
          sudo systemctl status xrdp --no-pager
          echo "=== XRDP-SESMAN Status ==="
          sudo systemctl status xrdp-sesman --no-pager
          
          # Test local connection
          timeout 5 bash -c "</dev/tcp/127.0.0.1/3389" 2>/dev/null
          if [ $? -eq 0 ]; then
              echo "Local RDP port 3389 is accessible"
          else
              echo "Local RDP port 3389 is NOT accessible"
          fi
          
          # Test Tailscale connection
          timeout 10 bash -c "</dev/tcp/$TAILSCALE_IP/3389" 2>/dev/null
          if [ $? -eq 0 ]; then
              echo "Tailscale RDP connectivity successful!"
          else
              echo "Tailscale RDP connectivity failed - but continuing anyway"
              echo "Try connecting directly to: $TAILSCALE_IP:3389"
          fi
          
      - name: Maintain Connection
        run: |
          echo ""
          echo "=== KALI TOOLS RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: TOOLBOXLAP"
          echo "Password: admin@123"
          echo "Desktop: XFCE4"
          echo "Tools: Metasploit, Nmap, Gobuster, etc."
          echo "=========================="
          echo ""
          while true; do
              echo "[$(date)] RDP Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
