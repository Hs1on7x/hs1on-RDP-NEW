name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    steps:
      - name: Install Kali Linux Environment
        run: |
          # Update system packages
          sudo apt-get update
          
          # Install Kali Linux keyring and repository
          wget -q -O - https://archive.kali.org/archive-key.asc | sudo apt-key add -
          echo "deb https://http.kali.org/kali kali-rolling main non-free contrib" | sudo tee /etc/apt/sources.list.d/kali.list
          sudo apt-get update
          
          # Install essential Kali tools and desktop environment
          sudo apt-get install -y kali-linux-core kali-desktop-xfce xrdp
          
          # Install additional security tools
          sudo apt-get install -y nmap metasploit-framework wireshark burpsuite sqlmap
          
      - name: Configure XRDP for Remote Desktop
        run: |
          # Enable and configure XRDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Configure XRDP to use XFCE desktop
          echo "startxfce4" | sudo tee /etc/skel/.xsession
          echo "startxfce4" > ~/.xsession
          chmod +x ~/.xsession
          
          # Configure XRDP settings
          sudo sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/#tcp_nodelay=1/tcp_nodelay=1/g' /etc/xrdp/xrdp.ini
          
          # Allow RDP through firewall
          sudo ufw allow 3389/tcp
          sudo ufw --force enable
          
          # Restart XRDP service
          sudo systemctl restart xrdp
          
      - name: Create RDP User with Static Password
        run: |
          # Create user account
          sudo useradd -m -s /bin/bash TOOLBOXLAP
          echo "TOOLBOXLAP:admin@123" | sudo chpasswd
          
          # Add user to sudo group
          sudo usermod -aG sudo TOOLBOXLAP
          
          # Create .xsession for the user
          sudo -u TOOLBOXLAP bash -c 'echo "startxfce4" > /home/TOOLBOXLAP/.xsession'
          sudo chmod +x /home/TOOLBOXLAP/.xsession
          
          # Set environment variable for credentials
          echo "RDP_CREDS=User: TOOLBOXLAP | Password: admin@123" >> $GITHUB_ENV
          
          # Verify user creation
          if ! id "TOOLBOXLAP" &>/dev/null; then
              echo "User creation failed"
              exit 1
          fi
          
      - name: Install Tailscale
        run: |
          # Add Tailscale repository
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          # Install Tailscale
          sudo apt-get update
          sudo apt-get install -y tailscale
          
      - name: Establish Tailscale Connection
        run: |
          # Connect to Tailscale network
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-runner-$GITHUB_RUN_ID
          
          # Wait for IP assignment
          sleep 10
          
          # Get Tailscale IP
          TAILSCALE_IP=$(tailscale ip -4)
          retries=0
          while [ -z "$TAILSCALE_IP" ] && [ $retries -lt 10 ]; do
              sleep 5
              TAILSCALE_IP=$(tailscale ip -4)
              retries=$((retries + 1))
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          
      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Test RDP port connectivity
          if nc -z $TAILSCALE_IP 3389; then
              echo "TCP connectivity to port 3389 successful!"
          else
              echo "TCP connection to RDP port 3389 failed"
              # Check if XRDP is running
              sudo systemctl status xrdp
              exit 1
          fi
          
      - name: Install Additional Kali Tools
        run: |
          # Install more penetration testing tools
          sudo apt-get install -y \
            aircrack-ng \
            john \
            hashcat \
            gobuster \
            nikto \
            dirb \
            hydra \
            netcat \
            socat \
            tcpdump \
            ettercap-text-only \
            dnsrecon \
            enum4linux \
            smbclient \
            nbtscan \
            onesixtyone \
            oscanner \
            sslscan \
            sslyze \
            whatweb \
            wpscan \
            firefox-esr
            
      - name: Maintain Connection
        run: |
          echo ""
          echo "=== KALI LINUX RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: TOOLBOXLAP"
          echo "Password: admin@123"
          echo "Desktop: XFCE4"
          echo "=========================="
          echo ""
          
          while true; do
              echo "[$(date)] Kali RDP Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
