name: RDP-Kali

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Setup Desktop + XRDP
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xrdp \
            firefox gedit dbus-x11 \
            net-tools unzip curl wget

          sudo systemctl enable xrdp xrdp-sesman

          sudo bash -c 'cat > /etc/xrdp/startwm.sh <<EOF
#!/bin/sh
if [ -r /etc/default/locale ]; then
  . /etc/default/locale
  export LANG LANGUAGE
fi
exec /usr/bin/startxfce4
EOF'
          sudo chmod +x /etc/xrdp/startwm.sh

      - name: Create RDP User
        run: |
          USERNAME="${{ secrets.RDP_USER || 'hs1on' }}"
          PASSWORD="${{ secrets.RDP_PASSWORD || 'admin@123' }}"

          if ! id "$USERNAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi

          echo "/usr/bin/startxfce4" | sudo tee /home/$USERNAME/.xsession
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME
          sudo chmod +x /home/$USERNAME/.xsession

          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -y
          sudo apt-get install -y tailscale

      - name: Connect to Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname="kali-runner-$GITHUB_RUN_ID" || true
          for i in {1..12}; do
            tsIP=$(tailscale ip -4 || true)
            [ -n "$tsIP" ] && break
            sleep 5
          done
          [ -z "$tsIP" ] && { echo "No Tailscale IP assigned"; exit 1; }
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      - name: Install Security Tools
        run: |
          sudo apt-get install -y nmap netcat-traditional git vim python3 python3-pip

          cd /tmp
          wget -q https://github.com/OJ/gobuster/releases/download/v3.6.0/gobuster_Linux_x86_64.tar.gz
          tar -xzf gobuster_Linux_x86_64.tar.gz && sudo mv gobuster /usr/local/bin/

          wget -q https://github.com/projectdiscovery/subfinder/releases/download/v2.6.3/subfinder_2.6.3_linux_amd64.zip
          unzip -q subfinder_2.6.3_linux_amd64.zip && sudo mv subfinder /usr/local/bin/

          wget -q https://github.com/projectdiscovery/httpx/releases/download/v1.3.7/httpx_1.3.7_linux_amd64.zip
          unzip -q httpx_1.3.7_linux_amd64.zip && sudo mv httpx /usr/local/bin/

          wget -q https://github.com/projectdiscovery/nuclei/releases/download/v3.0.4/nuclei_3.0.4_linux_amd64.zip
          unzip -q nuclei_3.0.4_linux_amd64.zip && sudo mv nuclei /usr/local/bin/

          pip3 install --user requests beautifulsoup4 scapy paramiko dnspython || true

          sudo -u $RDP_USER mkdir -p /home/$RDP_USER/Desktop
          cat <<EOF | sudo tee /home/$RDP_USER/Desktop/SecurityTools.txt
Security Tools Installed:
- nmap, nc
- gobuster, subfinder, httpx, nuclei
- python3 + security libraries
EOF
          sudo chown -R $RDP_USER:$RDP_USER /home/$RDP_USER/Desktop

      - name: Start RDP
        run: |
          sudo systemctl start xrdp-sesman
          sleep 3
          sudo systemctl start xrdp
          sleep 5
          sudo netstat -tlnp | grep -E "(3389|3350)" || true

      - name: Verify RDP
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          timeout 5 bash -c "</dev/tcp/127.0.0.1/3389" && echo "3389 open"
          timeout 5 bash -c "</dev/tcp/127.0.0.1/3350" && echo "3350 open"

      - name: Maintain Session
        run: |
          echo "=== RDP ACCESS INFO ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "Desktop: XFCE"
          echo "========================"
          while true; do
            echo "[$(date)] RDP Active"
            sleep 300
          done
