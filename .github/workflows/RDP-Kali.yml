name: RDP-Kali

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Setup Desktop + XRDP
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xrdp \
            firefox gedit dbus-x11 \
            net-tools unzip curl wget

          sudo systemctl enable xrdp xrdp-sesman

          sudo bash -c 'cat > /etc/xrdp/startwm.sh <<EOF
#!/bin/sh
if [ -r /etc/default/locale ]; then
  . /etc/default/locale
  export LANG LANGUAGE
fi
exec /usr/bin/startxfce4
EOF'
          sudo chmod +x /etc/xrdp/startwm.sh

      - name: Create RDP User
        run: |
          set -euo pipefail
          # read secrets into shell variables, then provide shell-level fallbacks
          USERNAME="${{ secrets.RDP_USER }}"
          PASSWORD="${{ secrets.RDP_PASSWORD }}"

          USERNAME=${USERNAME:-hs1on}
          PASSWORD=${PASSWORD:-admin@123}

          if ! id "$USERNAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          else
            echo "User $USERNAME exists, skipping creation"
          fi

          # ensure XFCE starts for that user
          echo "/usr/bin/startxfce4" | sudo tee /home/$USERNAME/.xsession >/dev/null
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME
          sudo chmod +x /home/$USERNAME/.xsession

          # export to later steps
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          set -euo pipefail
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -y
          sudo apt-get install -y tailscale

      - name: Connect to Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "ERROR: TAILSCALE_AUTH_KEY secret not provided."
            exit 1
          fi

          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="kali-runner-$GITHUB_RUN_ID" || true

          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 12 ]; do
            sleep 5
            tsIP=$(tailscale ip -4 || true)
            retries=$((retries + 1))
          done

          if [ -z "$tsIP" ]; then
            echo "No Tailscale IP assigned"
            exit 1
          fi

          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      - name: Install Security Tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y nmap netcat-traditional git vim python3 python3-pip

          cd /tmp

          # Gobuster
          if [ ! -x /usr/local/bin/gobuster ]; then
            wget -q https://github.com/OJ/gobuster/releases/download/v3.6.0/gobuster_Linux_x86_64.tar.gz
            tar -xzf gobuster_Linux_x86_64.tar.gz
            sudo mv gobuster /usr/local/bin/ || true
          fi

          # Subfinder
          if [ ! -x /usr/local/bin/subfinder ]; then
            wget -q https://github.com/projectdiscovery/subfinder/releases/download/v2.6.3/subfinder_2.6.3_linux_amd64.zip
            unzip -q subfinder_2.6.3_linux_amd64.zip
            sudo mv subfinder /usr/local/bin/ || true
          fi

          # httpx
          if [ ! -x /usr/local/bin/httpx ]; then
            wget -q https://github.com/projectdiscovery/httpx/releases/download/v1.3.7/httpx_1.3.7_linux_amd64.zip
            unzip -q httpx_1.3.7_linux_amd64.zip
            sudo mv httpx /usr/local/bin/ || true
          fi

          # nuclei
          if [ ! -x /usr/local/bin/nuclei ]; then
            wget -q https://github.com/projectdiscovery/nuclei/releases/download/v3.0.4/nuclei_3.0.4_linux_amd64.zip
            unzip -q nuclei_3.0.4_linux_amd64.zip
            sudo mv nuclei /usr/local/bin/ || true
          fi

          pip3 install --user requests beautifulsoup4 scapy paramiko dnspython || true

          # use exported env var RDP_USER from previous step
          sudo -u "$RDP_USER" mkdir -p /home/"$RDP_USER"/Desktop
          cat <<EOF | sudo tee /home/"$RDP_USER"/Desktop/SecurityTools.txt >/dev/null
Security Tools Installed:
- nmap, nc
- gobuster, subfinder, httpx, nuclei
- python3 + security libraries
EOF
          sudo chown -R "$RDP_USER:$RDP_USER" /home/"$RDP_USER"/Desktop || true

      - name: Start RDP
        run: |
          set -euo pipefail
          sudo systemctl start xrdp-sesman || true
          sleep 3
          sudo systemctl start xrdp || true
          sleep 5
          sudo netstat -tlnp | grep -E "(3389|3350)" || true

      - name: Verify RDP
        run: |
          set -euo pipefail
          echo "Tailscale IP: ${TAILSCALE_IP:-<unknown>}"
          timeout 5 bash -c "</dev/tcp/127.0.0.1/3389" && echo "3389 open" || echo "3389 closed"
          timeout 5 bash -c "</dev/tcp/127.0.0.1/3350" && echo "3350 open" || echo "3350 closed"

      - name: Maintain Session
        run: |
          set -euo pipefail
          echo "=== RDP ACCESS INFO ==="
          echo "Address: ${TAILSCALE_IP:-<unknown>}"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "Desktop: XFCE"
          echo "========================"
          # keep alive until workflow is cancelled
          while true; do
            echo "[$(date)] RDP Active"
            sleep 300
          done
