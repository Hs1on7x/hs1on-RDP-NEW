name: RDP-k  # Keeping your naming convention
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: ubuntu-latest  # Changed from windows-latest
    timeout-minutes: 3600
    steps:
      - name: Configure SSH Server (Linux RDP Equivalent)
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh

          # Optional: Allow root login (not recommended for prod, but for lab)
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          echo "PasswordAuthentication yes" | sudo tee -a /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Create SSH User with Static Password
        run: |
          PASSWORD="admin@123"
          USERNAME="TOOLBOXLAP"

          # Create user if doesn't exist
          if ! id "$USERNAME" &>/dev/null; then
              sudo useradd -m -s /bin/bash "$USERNAME"
              echo "$USERNAME:$PASSWORD" | sudo chpasswd
          fi

          # Add to sudo group
          sudo usermod -aG sudo "$USERNAME"

          # Export creds to GitHub env
          echo "RDP_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV

          # Verify user exists
          if ! id "$USERNAME" &>/dev/null; then
              echo "User creation failed" >&2
              exit 1
          fi

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${GITHUB_RUN_ID}

          TAILSCALE_IP=""
          retries=0
          while [ -z "$TAILSCALE_IP" ] && [ $retries -lt 10 ]; do
              TAILSCALE_IP=$(tailscale ip -4 2>/dev/null)
              sleep 5
              retries=$((retries + 1))
          done

          if [ -z "$TAILSCALE_IP" ]; then
              echo "Tailscale IP not assigned. Exiting." >&2
              exit 1
          fi

          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      - name: Verify SSH Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv $TAILSCALE_IP 22
          if [ $? -ne 0 ]; then
              echo "SSH port 22 unreachable" >&2
              exit 1
          fi
          echo "SSH connectivity successful!"

      - name: (Optional) Install GUI + xRDP for Desktop Access (Kali Desktop)
        run: |
          # Install Kali desktop + xRDP (heavy, skip if SSH-only)
          sudo apt-get install -y kali-desktop-xfce xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

          # Set password for xRDP (same user)
          echo "TOOLBOXLAP:admin@123" | sudo chpasswd

          echo "xRDP installed. Connect via RDP client to $TAILSCALE_IP port 3389 (if forwarded)."

      - name: Maintain Connection
        run: |
          echo
          echo "=== SSH ACCESS (Your 'Linux RDP') ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: TOOLBOXLAP"
          echo "Password: admin@123"
          echo "Port: 22 (SSH) â€” Use: ssh TOOLBOXLAP@$TAILSCALE_IP"
          echo
          if systemctl is-active --quiet xrdp; then
              echo "GUI via xRDP: Connect to $TAILSCALE_IP:3389"
          fi
          echo "======================================"
          echo

          while true; do
              echo "[$(date)] SSH Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
