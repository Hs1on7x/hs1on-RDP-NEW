name: macOS-RDP
on:
  workflow_dispatch:

jobs:
  macos-rdp:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable VNC Screen Sharing
        run: |
          sudo systemsetup -setremotelogin on
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "admin@123" \
            -restart -agent -privs -all

      - name: Create Remote User
        run: |
          sudo dscl . -create /Users/toolmac
          sudo dscl . -create /Users/toolmac UserShell /bin/bash
          sudo dscl . -create /Users/toolmac RealName "toolmac"
          sudo dscl . -passwd /Users/toolmac admin@123
          sudo dscl . -create /Users/toolmac UniqueID 550
          sudo dscl . -create /Users/toolmac PrimaryGroupID 20
          sudo dscl . -create /Users/toolmac NFSHomeDirectory /Users/toolmac
          sudo dscl . -append /Groups/admin GroupMembership toolmac
          sudo createhomedir -c -u toolmac > /dev/null

      ##########################################
      #   FIXED â€” TRUE WORKING TAILSCALE CLI   #
      ##########################################
      - name: Install Tailscale (Binary)
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_apple_universal.tgz | tar -xz
          sudo mv tailscale*/tailscale /usr/local/bin/
          sudo mv tailscale*/tailscaled /usr/local/bin/
          sudo tailscaled &

      - name: Connect Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=mac-runner-${GITHUB_RUN_ID}

      - name: Get Tailscale IP
        run: |
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      - name: Show Connection Info
        run: |
          echo "=============================="
          echo " macOS RDP (VNC) ACCESS"
          echo "=============================="
          echo "Tailscale IP:  $TS_IP"
          echo "Port:          5900"
          echo "Username:      toolmac"
          echo "Password:      admin@123"
          echo "=============================="

      - name: Keep Session Alive
        run: |
          while true; do
            echo "[$(date)] macOS VNC Active"
            sleep 300
          done
