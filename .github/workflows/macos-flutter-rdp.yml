name: macOS-RDP
on:
  workflow_dispatch:

jobs:
  macos-rdp:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1️⃣ تفعيل VNC / Remote Management
      - name: Enable VNC Screen Sharing
        run: |
          sudo systemsetup -setremotelogin on
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "admin@123" \
            -restart -agent -privs -all

      # 2️⃣ إنشاء مستخدم ثابت للوصول
      - name: Create Remote User with Static Password
        run: |
          USERNAME="toolmac"
          PASSWORD="admin@123"

          if ! id -u $USERNAME >/dev/null 2>&1; then
            sudo dscl . -create /Users/$USERNAME
            sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
            sudo dscl . -create /Users/$USERNAME RealName $USERNAME
            sudo dscl . -passwd /Users/$USERNAME $PASSWORD
            sudo dscl . -create /Users/$USERNAME UniqueID 550
            sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
            sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
            sudo dscl . -append /Groups/admin GroupMembership $USERNAME
            sudo createhomedir -c -u $USERNAME > /dev/null
          fi

      # 3️⃣ تثبيت Tailscale CLI وتشغيله - FIXED DOWNLOAD
      - name: Install Tailscale CLI
        run: |
          echo "Downloading Tailscale CLI (macOS)..."
          # Use the correct download URL with proper headers and verification
          curl -L -o tailscale.tgz "https://pkgs.tailscale.com/stable/tailscale-macos-amd64.tgz"
          
          # Verify the downloaded file size (should be more than 10 bytes)
          FILE_SIZE=$(wc -c < tailscale.tgz)
          echo "Downloaded file size: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -le 100 ]; then
            echo "Error: Downloaded file is too small ($FILE_SIZE bytes). Download failed."
            exit 1
          fi
          
          tar -xzf tailscale.tgz
          sudo mv tailscale*/tailscale /usr/local/bin/
          sudo mv tailscale*/tailscaled /usr/local/bin/
          sudo tailscaled &
          sleep 5

      # 4️⃣ الاتصال بشبكة Tailscale
      - name: Connect Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=mac-runner-${GITHUB_RUN_ID}
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      # 5️⃣ التحقق من الاتصال وعرض بيانات الدخل
      - name: Show RDP / VNC Connection Info
        run: |
          echo "=============================="
          echo " macOS RDP (VNC) ACCESS"
          echo "=============================="
          echo "Tailscale IP:  $TS_IP"
          echo "Port:          5900"
          echo "Username:      toolmac"
          echo "Password:      admin@123"
          echo "=============================="

      # 6️⃣ الحفاظ على الجلسة نشطة
      - name: Keep Session Alive
        run: |
          while true; do
            echo "[$(date)] macOS VNC Active"
            sleep 300
          done
