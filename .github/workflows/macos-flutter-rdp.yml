name: RDP
on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable SSH & Create User
        run: |
          sudo systemsetup -setremotelogin on
          
          USERNAME="TOOLBOXLAP"
          PASSWORD="admin@123"
          
          if ! id "$USERNAME" &>/dev/null; then
            sudo sysadminctl -addUser "$USERNAME" -password "$PASSWORD" -admin
          fi
          
          echo "SSH_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Enable VNC (Screen Sharing / GUI Access)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw admin123 \
            -restart -agent -privs -all || true

      - name: Install & Start Tailscale
        run: |
          brew install tailscale || true
          
          # ✅ Correct way to start tailscaled via brew
          sudo /opt/homebrew/opt/tailscale/bin/tailscaled &
          sleep 10
          
          # Verify it's running
          pgrep tailscaled && echo "tailscaled is running" || echo "tailscaled failed to start"

      - name: Establish Tailscale Connection
        run: |
          sudo /opt/homebrew/opt/tailscale/bin/tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-mac-${{ github.run_id }}
          
          RETRIES=0
          TS_IP=""
          while [ -z "$TS_IP" ] && [ $RETRIES -lt 15 ]; do
            TS_IP=$(/opt/homebrew/opt/tailscale/bin/tailscale ip -4 2>/dev/null || true)
            sleep 5
            RETRIES=$((RETRIES+1))
          done
          
          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify Ports
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv "$TAILSCALE_IP" 22   && echo "✅ SSH port open"  || echo "❌ SSH port failed"
          nc -zv "$TAILSCALE_IP" 5900 && echo "✅ VNC port open"  || echo "❌ VNC port failed"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== MAC ACCESS INFO ==="
          echo "Tailscale IP  : $TAILSCALE_IP"
          echo "SSH           : ssh TOOLBOXLAP@$TAILSCALE_IP"
          echo "SSH Password  : admin@123"
          echo "VNC (GUI)     : $TAILSCALE_IP:5900  |  Password: admin123"
          echo "========================"
          echo ""
          while true; do
            echo "[$(date)] Session Active - Ctrl+C to terminate"
            sleep 300
          done
