name: macOS-RDP
on:
  workflow_dispatch:

jobs:
  macos-rdp:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1️⃣ Enable VNC Screen Sharing with proper configuration
      - name: Enable VNC Screen Sharing
        run: |
          sudo systemsetup -setremotelogin on
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          
          # Configure VNC with proper settings for headless environment
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "admin@123" \
            -restart -agent -privs -all

          # Start VNC server with proper display
          sudo /usr/bin/vncserver -geometry 1920x1080 -depth 24 -rfbauth ~/.vnc/passwd -localhost no

      # 2️⃣ Create Remote User and ensure GUI session
      - name: Create Remote User with GUI Session
        run: |
          USERNAME="toolmac"
          PASSWORD="admin@123"

          if ! id -u $USERNAME >/dev/null 2>&1; then
            sudo dscl . -create /Users/$USERNAME
            sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
            sudo dscl . -create /Users/$USERNAME RealName $USERNAME
            sudo dscl . -passwd /Users/$USERNAME $PASSWORD
            sudo dscl . -create /Users/$USERNAME UniqueID 550
            sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
            sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
            sudo dscl . -append /Groups/admin GroupMembership $USERNAME
            sudo createhomedir -c -u $USERNAME > /dev/null
          fi

          # Ensure user can login and has proper permissions
          sudo defaults write /Library/Preferences/com.apple.loginwindow AutoLoginUser $USERNAME
          sudo defaults write /Library/Preferences/com.apple.loginwindow AutoLoginPasswordHint "admin@123"
          sudo defaults write /Library/Preferences/com.apple.loginwindow AutoLoginDelay 0

      # 3️⃣ Install Tailscale with Homebrew
      - name: Install Tailscale CLI
        run: |
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
          echo "Installing Tailscale..."
          brew install tailscale
          sudo brew services start tailscale

      # 4️⃣ Disable Firewall
      - name: Disable Firewall for Testing
        run: |
          echo "Disabling macOS firewall..."
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off

      # 5️⃣ Connect to Tailscale
      - name: Connect Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=mac-runner-${GITHUB_RUN_ID}
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      # 6️⃣ Verify VNC is working with detailed debugging
      - name: Verify VNC Connection
        run: |
          echo "=============================="
          echo " macOS VNC ACCESS"
          echo "=============================="
          echo "Tailscale IP:  $TS_IP"
          echo "Port:          5900"
          echo "Username:      toolmac"
          echo "Password:      admin@123"
          echo "=============================="
          
          # Check VNC server status
          echo "Checking VNC server status..."
          ps aux | grep vnc
          
          # Check display information
          echo "Display information:"
          /usr/bin/vncserver -list
          
          # Test VNC connection locally
          echo "Testing VNC connection locally..."
          vncviewer localhost:5900 -passwd <(echo "admin@123") -norepeat

      # 7️⃣ Keep Session Alive
      - name: Keep Session Alive
        run: |
          while true; do
            echo "[$(date)] macOS VNC Active"
            # Keep the VNC server running
            sudo /usr/bin/vncserver -kill :1 2>/dev/null || true
            sudo /usr/bin/vncserver :1 -geometry 1920x1080 -depth 24 -rfbauth ~/.vnc/passwd -localhost no
            sleep 300
          done
