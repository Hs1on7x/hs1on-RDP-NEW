name: RDP
on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable SSH & Create User
        run: |
          sudo systemsetup -setremotelogin on
          
          USERNAME="TOOLBOXLAP"
          PASSWORD="admin@123"
          
          # Create user if not exists
          if ! id "$USERNAME" &>/dev/null; then
            sudo sysadminctl -addUser "$USERNAME" -password "$PASSWORD" -admin
          fi
          
          echo "SSH_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Enable VNC (Screen Sharing / GUI Access)
        run: |
          # Enable Screen Sharing (VNC)
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true

          # Set VNC password
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw admin123 \
            -restart -agent -privs -all || true

      - name: Install Tailscale
        run: |
          brew install tailscale || true
          sudo /Applications/Tailscale.app/Contents/MacOS/Tailscaled &
          sleep 5

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-mac-${{ github.run_id }}
          
          RETRIES=0
          TS_IP=""
          while [ -z "$TS_IP" ] && [ $RETRIES -lt 10 ]; do
            TS_IP=$(tailscale ip -4 2>/dev/null || true)
            sleep 5
            RETRIES=$((RETRIES+1))
          done
          
          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify SSH Connectivity
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          # Test SSH port
          nc -zv "$TAILSCALE_IP" 22 && echo "SSH port open!" || echo "SSH port check failed"
          # Test VNC port
          nc -zv "$TAILSCALE_IP" 5900 && echo "VNC port open!" || echo "VNC port check failed"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== MAC ACCESS INFO ==="
          echo "Tailscale IP : $TAILSCALE_IP"
          echo "SSH          : ssh TOOLBOXLAP@$TAILSCALE_IP"
          echo "SSH Password : admin@123"
          echo "VNC (GUI)    : vnc://$TAILSCALE_IP:5900  |  Password: admin123"
          echo "========================"
          echo ""
          while true; do
            echo "[$(date)] Session Active - Ctrl+C to terminate"
            sleep 300
          done
