name: macOS-RDP
on:
  workflow_dispatch:

jobs:
  macos-rdp:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1️⃣ Enable VNC Screen Sharing
      - name: Enable VNC Screen Sharing
        run: |
          sudo systemsetup -setremotelogin on
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "admin@123" \
            -restart -agent -privs -all

      # 2️⃣ Create Remote User
      - name: Create Remote User with Static Password
        run: |
          USERNAME="toolmac"
          PASSWORD="admin@123"

          if ! id -u $USERNAME >/dev/null 2>&1; then
            sudo dscl . -create /Users/$USERNAME
            sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
            sudo dscl . -create /Users/$USERNAME RealName $USERNAME
            sudo dscl . -passwd /Users/$USERNAME $PASSWORD
            sudo dscl . -create /Users/$USERNAME UniqueID 550
            sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
            sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
            sudo dscl . -append /Groups/admin GroupMembership $USERNAME
            sudo createhomedir -c -u $USERNAME > /dev/null
          fi

      # 3️⃣ Install Tailscale with Homebrew (FIXED)
      - name: Install Tailscale CLI with Homebrew
        run: |
          # Install Homebrew if needed
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
          # Install Tailscale
          echo "Installing Tailscale..."
          brew install tailscale
          
          # Start tailscaled service
          sudo brew services start tailscale

      # 4️⃣ Disable Firewall Temporarily
      - name: Disable Firewall for Testing
        run: |
          echo "Disabling macOS firewall..."
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off

      # 5️⃣ Connect to Tailscale
      - name: Connect Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=mac-runner-${GITHUB_RUN_ID}
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      # 6️⃣ Show Connection Info
      - name: Show VNC Connection Info
        run: |
          echo "=============================="
          echo " macOS VNC ACCESS (NOT RDP)"
          echo "=============================="
          echo "Tailscale IP:  $TS_IP"
          echo "Port:          5900 (VNC)"
          echo "Username:      toolmac"
          echo "Password:      admin@123"
          echo "=============================="
          echo "Use a VNC client, NOT RDP!"
          echo "=============================="

      # 7️⃣ Keep Session Alive
      - name: Keep Session Alive
        run: |
          while true; do
            echo "[$(date)] macOS VNC Active"
            sleep 300
          done
